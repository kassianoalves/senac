<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meus vídeos — YouShip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>

<body data-page="meus-videos">
    <div id="youship-header"></div>
    <div class="container py-4">
        <div class="row">
            <aside class="col-12 col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
                <nav class="nav flex-column">
                    <a class="nav-link" href="../index.html"><i class="bi bi-house-door-fill me-2"></i>Início</a>
                    <a class="nav-link" href="ao-vivo.html"><i class="bi bi-broadcast-pin me-2"></i>Ao Vivo</a>
                    <a class="nav-link" href="louvor.html"><i class="bi bi-music-note-list me-2"></i>Louvor</a>
                    <a class="nav-link" href="podcast.html"><i class="bi bi-mic-fill me-2"></i>PodCast</a>
                    <hr>
                    <a class="nav-link active" href="meus-videos.html"><i class="bi bi-film me-2"></i>Meus vídeos</a>
                </nav>
            </aside>

            <main class="col-12 col-md-9 col-lg-10 p-3">
                <h4>Meus vídeos</h4>
                <p class="text-muted">Aqui estão os vídeos enviados por você. Edite título, legenda, categoria ou
                    thumbnail.</p>
                <div id="uploadsArea" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3"></div>
            </main>
        </div>
    </div>

    <!-- Edit modal -->
    <div class="modal fade" id="editUploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar vídeo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUploadForm">
                        <input type="hidden" id="editUploadId" />
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <img id="editThumbPreview" src="https://via.placeholder.com/320x180"
                                    class="img-fluid rounded mb-2" alt="thumb">
                                <div class="mb-2">
                                    <input id="editThumbFile" type="file" accept="image/*"
                                        class="form-control form-control-sm" />
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="regenThumbBtn" class="btn btn-outline-secondary btn-sm"
                                        type="button">Gerar thumb do vídeo</button>
                                    <button id="deleteUploadBtn" class="btn btn-outline-danger btn-sm"
                                        type="button">Excluir vídeo</button>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <label class="form-label">Título</label>
                                    <input id="editTitle" class="form-control" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Legenda / Descrição</label>
                                    <textarea id="editDesc" class="form-control" rows="4"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Categoria</label>
                                    <select id="editCategory" class="form-select">
                                        <option value="home">Home (aparece em Início)</option>
                                        <option value="ao-vivo">Ao Vivo</option>
                                        <option value="louvor">Louvor</option>
                                        <option value="podcast">PodCast</option>
                                        <option value="teatro">Teatro</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Visibilidade</label>
                                    <select id="editVisibility" class="form-select">
                                        <option value="public">Público</option>
                                        <option value="private">Privado (somente você)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="saveEditBtn" class="btn btn-primary">Salvar</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/uploads.js"></script>
    <script src="../js/header.js"></script>
    <script>
        (function () {
            const area = document.getElementById('uploadsArea');
            const auth = localStorage.getItem('youshipAuth');
            if (!auth) { alert('Você precisa estar logado para ver seus vídeos.'); location.href = (location.pathname.indexOf('/html/') !== -1 ? 'login.html' : 'html/login.html'); return; }
            const userRaw = localStorage.getItem('youshipUser');
            let channel = auth;
            try { const u = JSON.parse(userRaw); if (u && u.channel && u.channel.name) channel = u.channel.name; else if (u && u.name) channel = u.name; } catch (e) { }

            function renderList() {
                YouShipUploads.listUploads().then(list => {
                    // filtrar pelo canal/usuário
                    const my = list.filter(x => x && x.id).map(x => ({ id: x.id, name: x.name, ts: x.ts, thumb: x.thumb || null }));
                    // tentar cruzar com localStorage.youshipUploads para obter title/channel/category
                    const metaRaw = localStorage.getItem('youshipUploads');
                    const metas = metaRaw ? JSON.parse(metaRaw) : [];
                    const myMetas = metas.filter(m => m && m.id && (m.channel === channel || (m.owner && m.owner === auth) || true));
                    // join by id
                    const rows = myMetas.map(m => Object.assign({}, m, { thumb: m.thumb || m.thumbDataUrl || ((my.find(x => x.id === m.id) || {}).thumb || null) }));
                    if (rows.length === 0) { area.innerHTML = '<div class="small text-muted">Você ainda não enviou vídeos.</div>'; return; }
                    area.innerHTML = rows.map(r => `
            <div class="col">
              <div class="card h-100 shadow-sm">
                <img src="${r.thumb || 'https://via.placeholder.com/480x270/ddd/444?text=Sem+Thumb'}" class="card-img-top" alt="${r.title || r.id}">
                <div class="card-body p-2">
                  <h6 class="mb-1">${r.title || r.id}</h6>
                  <div class="small text-muted">${r.channel || ''} • ${new Date(r.ts).toLocaleString()}</div>
                  <div class="mt-2 d-flex justify-content-between align-items-center">
                    <div class="small text-muted">${r.category || 'home'}</div>
                    <div><button class="btn btn-sm btn-outline-primary btn-edit" data-id="${r.id}">Editar</button></div>
                  </div>
                </div>
              </div>
            </div>
          `).join('');

                    // attach edit handlers
                    document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', (e) => { openEdit(b.dataset.id); }));
                }).catch(err => { console.error(err); area.innerHTML = '<div class="alert alert-danger">Erro ao listar uploads.</div>'; });
            }

            function openEdit(id) {
                // carregar meta
                const modal = new bootstrap.Modal(document.getElementById('editUploadModal'));
                YouShipUploads.getUploadMeta(id).then(meta => {
                    if (!meta) { alert('Metadados não encontrados'); return; }
                    document.getElementById('editUploadId').value = id;
                    document.getElementById('editTitle').value = meta.title || meta.name || '';
                    document.getElementById('editDesc').value = meta.description || meta.desc || '';
                    document.getElementById('editCategory').value = meta.category || 'home';
                    document.getElementById('editVisibility').value = meta.visibility || 'public';
                    document.getElementById('editThumbPreview').src = meta.thumbDataUrl || meta.thumb || 'https://via.placeholder.com/320x180';
                    modal.show();
                }).catch(err => { console.error(err); alert('Erro ao abrir editor'); });
            }

            // save edit
            document.getElementById('saveEditBtn').addEventListener('click', async () => {
                const id = document.getElementById('editUploadId').value;
                const title = document.getElementById('editTitle').value.trim();
                const desc = document.getElementById('editDesc').value.trim();
                const category = document.getElementById('editCategory').value;
                const visibility = document.getElementById('editVisibility').value;
                const thumbFile = document.getElementById('editThumbFile').files && document.getElementById('editThumbFile').files[0];
                try {
                    let thumbDataUrl = null;
                    if (thumbFile) {
                        // read file
                        thumbDataUrl = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = () => rej(r.error); r.readAsDataURL(thumbFile); });
                    }
                    // if user requested regen via button we'll handle there; here just update meta
                    const updates = { title, description: desc, category, visibility };
                    if (thumbDataUrl) updates.thumbDataUrl = thumbDataUrl;
                    await YouShipUploads.updateUploadMeta(id, updates);
                    // update localStorage.youshipUploads
                    try {
                        const raw = localStorage.getItem('youshipUploads');
                        const arr = raw ? JSON.parse(raw) : [];
                        const idx = arr.findIndex(x => String(x.id) === String(id));
                        if (idx !== -1) { arr[idx] = Object.assign({}, arr[idx], updates); }
                        else arr.unshift(Object.assign({ id, title, channel: localStorage.getItem('youshipAuth'), ts: Date.now() }, updates));
                        localStorage.setItem('youshipUploads', JSON.stringify(arr));
                    } catch (e) { console.warn('Could not sync localStorage metadata', e); }
                    // close modal and refresh
                    bootstrap.Modal.getInstance(document.getElementById('editUploadModal')).hide();
                    renderList();
                } catch (e) { console.error(e); alert('Erro ao salvar alterações.'); }
            });

            // regen thumb from video
            document.getElementById('regenThumbBtn').addEventListener('click', async () => {
                const id = document.getElementById('editUploadId').value;
                if (!id) return alert('Selecione um vídeo primeiro');
                try {
                    const blob = await YouShipUploads.getUploadBlob(id);
                    if (!blob) return alert('Arquivo não encontrado para gerar thumbnail');
                    // generate thumbnail using the same approach as uploads.js (create video + canvas)
                    const url = URL.createObjectURL(blob);
                    const video = document.createElement('video'); video.preload = 'metadata'; video.src = url; video.muted = true; video.playsInline = true;
                    const awaitLoaded = () => new Promise((res, rej) => { video.addEventListener('loadeddata', () => res(), { once: true }); video.addEventListener('error', (e) => rej(e), { once: true }); });
                    await awaitLoaded();
                    const seekTime = Math.min(0.5, Math.max(0, (video.duration || 0) * 0.1));
                    video.currentTime = seekTime;
                    await new Promise((res) => { video.addEventListener('seeked', () => res(), { once: true }); setTimeout(res, 1500); });
                    const canvas = document.createElement('canvas'); const w = Math.min(480, video.videoWidth || 480); const h = Math.round(w * ((video.videoHeight || 270) / (video.videoWidth || 480))); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    URL.revokeObjectURL(url);
                    // update
                    await YouShipUploads.updateUploadMeta(id, { thumbDataUrl: dataUrl });
                    // update localStorage meta
                    try { const raw = localStorage.getItem('youshipUploads'); const arr = raw ? JSON.parse(raw) : []; const idx = arr.findIndex(x => String(x.id) === String(id)); if (idx !== -1) { arr[idx].thumb = dataUrl; } else { arr.unshift({ id, title: '', channel: localStorage.getItem('youshipAuth'), ts: Date.now(), thumb: dataUrl }); } localStorage.setItem('youshipUploads', JSON.stringify(arr)); } catch (e) { }
                    document.getElementById('editThumbPreview').src = dataUrl;
                    alert('Thumbnail gerado com sucesso');
                } catch (e) { console.error(e); alert('Erro ao gerar thumbnail: ' + (e && e.message)); }
            });

            // delete upload
            document.getElementById('deleteUploadBtn').addEventListener('click', async () => {
                if (!confirm('Deseja realmente excluir este vídeo? Esta ação não pode ser desfeita.')) return;
                const id = document.getElementById('editUploadId').value;
                try {
                    await YouShipUploads.deleteUpload(id);
                    // remove from localStorage metadata
                    try { const raw = localStorage.getItem('youshipUploads'); const arr = raw ? JSON.parse(raw) : []; const idx = arr.findIndex(x => String(x.id) === String(id)); if (idx !== -1) { arr.splice(idx, 1); localStorage.setItem('youshipUploads', JSON.stringify(arr)); } } catch (e) { }
                    bootstrap.Modal.getInstance(document.getElementById('editUploadModal')).hide();
                    renderList();
                } catch (e) { console.error(e); alert('Erro ao excluir: ' + (e && e.message)); }
            });

            // initial render
            setTimeout(renderList, 80);
        })();
    </script>
</body>

</html>