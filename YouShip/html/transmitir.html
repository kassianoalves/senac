<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YouShip — Transmitir (OBS)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="../css/style.css" rel="stylesheet">
</head>
<body data-page="transmitir">

  <div id="youship-header"></div>

  <div class="container py-4">
    <div class="row">
      <aside class="col-12 col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
        <nav class="nav flex-column">
          <a class="nav-link" href="../index.html"><i class="bi bi-house-door-fill me-2"></i>Início</a>
          <a class="nav-link" href="ao-vivo.html"><i class="bi bi-broadcast-pin me-2"></i>Ao Vivo</a>
          <a class="nav-link" href="louvor.html"><i class="bi bi-music-note-list me-2"></i>Louvor</a>
          <a class="nav-link" href="podcast.html"><i class="bi bi-mic-fill me-2"></i>PodCast</a>
          <a class="nav-link" href="teatro.html"><i class="bi bi-easel me-2"></i>Teatro</a>
        </nav>
      </aside>

      <main class="col-12 col-md-9 col-lg-10 p-3">
        <h4>Transmitir ao vivo com OBS Studio</h4>
        <p class="text-muted">Esta página orienta como configurar o OBS para transmitir. Como este é um site estático, fornecemos duas opções:
        <ul>
          <li>Usar um servidor RTMP seu (ex.: Nginx + rtmp module) e apontar o OBS para ele.</li>
          <li>Simular uma transmissão: ao clicar em "Iniciar Transmissão (Simular)", o site cria uma entrada local (em <code>localStorage</code>) que aparecerá na página Ao Vivo como uma transmissão "Agora". Útil para testes locais.</li>
        </ul>
        </p>

        <section class="mb-3">
          <h5>Passo a passo (OBS → servidor RTMP)</h5>
          <ol>
            <li>Instale o OBS Studio (https://obsproject.com/).</li>
            <li>Vá em Configurações → Transmissão.</li>
            <li>Escolha o serviço (ex.: <em>Custom</em>) e informe o servidor RTMP (ex.: <code>rtmp://seu-servidor/live</code>) e a chave de transmissão.</li>
            <li>No campo Chave de Transmissão, cole a <strong>Stream Key</strong> gerada abaixo (ou forneça a sua se usar um serviço externo como YouTube).</li>
            <li>Clique em "Iniciar Transmissão" no OBS. O servidor RTMP receberá o feed e você verá a transmissão na página Ao Vivo se o servidor estiver configurado para distribuí-la.</li>
          </ol>
        </section>

        <section class="mb-4">
          <h5>Gerar Stream Key (demo)</h5>
          <p class="small text-muted">A chave gerada aqui é apenas local (armazenada em localStorage) e serve para fins de teste. Para uma transmissão real, configure um RTMP público/privado e use a chave fornecida por esse serviço.</p>
          <div class="mb-2">
            <label class="form-label">Título da transmissão</label>
            <input id="liveTitle" class="form-control" placeholder="Título da sua live (ex: Culto Ao Vivo)" />
          </div>
          <div class="mb-2">
            <button id="generateKey" class="btn btn-outline-primary">Gerar Stream Key</button>
            <button id="startSim" class="btn btn-primary ms-2">Iniciar Transmissão (Simular)</button>
          </div>
          <div id="keyArea" class="mt-3"></div>
          <div id="manageArea" class="mt-3"></div>
        </section>

        <section>
          <h5>Observações importantes</h5>
          <ul>
            <li>Para transmissões reais o site precisará de um servidor RTMP/ingest. Exemplos: Nginx+rtmp, Wowza, Ant Media, ou serviços como YouTube/Twitch.</li>
            <li>Transmitir diretamente para um site estático não é possível sem um backend/servidor de streaming.</li>
            <li>Esta página oferece uma <em>simulação</em> (útil para testar a UI e o fluxo).</li>
          </ul>
        </section>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/header.js"></script>
  <script>
    // Comentários (PT-BR):
    // - Esta página gera uma stream key local e permite simular uma transmissão criando
    //   um objeto em localStorage chamado 'liveStreams'. O app principal (js/app.js)
    //   carrega essas transmissões e as mostra na página Ao Vivo como 'Agora'.
    // - Para implementar transmissão real é preciso configurar um servidor RTMP e
    //   redirecionar o OBS para esse servidor (não faremos isso no site estático).

    function ensureAuth(){
      const auth = localStorage.getItem('youshipAuth');
      if(!auth){
        if(confirm('Você precisa entrar para transmitir. Deseja entrar agora?')) location.href='login.html';
        else location.href='cadastro.html';
        return false;
      }
      return true;
    }

    document.getElementById('generateKey').addEventListener('click', ()=>{
      if(!ensureAuth()) return;
      // gerar chave simples (não segura) - apenas para demo local
      const key = Math.random().toString(36).slice(2,12);
      localStorage.setItem('youshipStreamKey', key);
      document.getElementById('keyArea').innerHTML = `<div class="alert alert-success">Stream Key (demo): <code>${key}</code><br>RTMP URL de exemplo: <code>rtmp://seu-servidor/live</code></div>`;
    });

    document.getElementById('startSim').addEventListener('click', ()=>{
      if(!ensureAuth()) return;
      const title = document.getElementById('liveTitle').value || 'Live (simulada)';
      const auth = localStorage.getItem('youshipAuth');
      const userRaw = localStorage.getItem('youshipUser');
      let name = auth;
      try{ const u = JSON.parse(userRaw); if(u && u.name) name = u.name; }catch(e){}
      // criar objeto de transmissão em localStorage para o app carregar
      const live = { id: 'live-' + Date.now(), title: title, channel: name, viewsText: '0 assistindo', viewsCount:0, time: 'Agora', thumb: 'https://via.placeholder.com/480x270/ff7a66/ffffff?text=Live', category: 'ao-vivo', ts: Date.now()/1000, live:true };
      const raw = localStorage.getItem('liveStreams');
      const arr = raw ? JSON.parse(raw) : [];
      arr.unshift(live);
      localStorage.setItem('liveStreams', JSON.stringify(arr));
      alert('Transmissão simulada criada. Vá para Ao Vivo para visualizar.');
      location.href = 'ao-vivo.html';
    });
    // Gerenciamento: mostrar chave atual e transmissões ativas, permitir revogar
    function renderManage(){
      const manage = document.getElementById('manageArea');
      const key = localStorage.getItem('youshipStreamKey');
      const liveRaw = localStorage.getItem('liveStreams');
      const lives = liveRaw ? JSON.parse(liveRaw) : [];
      let html = '';
      if(key) html += `<div class="mb-2"><strong>Chave atual:</strong> <code>${key}</code> <button id="revokeKey" class="btn btn-sm btn-outline-danger ms-2">Revogar</button></div>`;
      else html += '<div class="mb-2 small text-muted">Nenhuma chave gerada.</div>';
      html += '<h6>Transmissões simuladas</h6>';
      if(lives.length===0) html += '<div class="small text-muted">Nenhuma transmissão ativa.</div>';
      else html += '<div>' + lives.map(l=>`<div class="d-flex justify-content-between align-items-center py-1"><div><strong>${l.title}</strong> — ${l.channel} <small class="text-muted">(${l.time})</small></div><div><button class="btn btn-sm btn-outline-danger btn-stop" data-id="${l.id}">Parar</button></div></div>`).join('') + '</div>';
      manage.innerHTML = html;
      const rk = document.getElementById('revokeKey'); if(rk) rk.addEventListener('click', ()=>{ localStorage.removeItem('youshipStreamKey'); renderManage(); alert('Chave revogada.'); });
      document.querySelectorAll('.btn-stop').forEach(b=> b.addEventListener('click', ()=>{ const id = b.dataset.id; const arr = JSON.parse(localStorage.getItem('liveStreams')||'[]'); const idx = arr.findIndex(x=>x.id===id); if(idx!==-1){ arr.splice(idx,1); localStorage.setItem('liveStreams', JSON.stringify(arr)); renderManage(); alert('Transmissão parada.'); } }));
    }
    // init manage
    setTimeout(renderManage,50);
    // Quando a página for visível novamente (ex: volta do login), re-renderizar
    window.addEventListener('focus', renderManage);
  </script>
</body>
</html>
