<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Configurar Transmissão — YouShip</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="../css/style.css" rel="stylesheet">
</head>
<body data-page="transmit">
  <div id="youship-header"></div>
  <div class="container py-4">
    <div id="transmitArea"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/uploads.js"></script>
  <script src="../js/header.js"></script>
  <script>
    // Configuração simplificada de transmissão (demo)
    const area = document.getElementById('transmitArea');
    const auth = localStorage.getItem('youshipAuth');
    const inHtml = location.pathname.indexOf('/html/') !== -1;
    const loginPath = inHtml ? 'login.html' : 'html/login.html';
    const registerPath = inHtml ? 'cadastro.html' : 'html/cadastro.html';
    if(!auth){
      const go = confirm('Você precisa entrar para configurar transmissão. Entrar agora? (OK = Entrar / Cancel = Criar conta)');
      if(go) location.href = loginPath; else location.href = registerPath;
    }else{
      // gerar ou exibir stream key demo
      function ensureKey(){
        let key = localStorage.getItem('youshipStreamKey');
        if(!key){ key = 'live-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); localStorage.setItem('youshipStreamKey', key); }
        return key;
      }
      const key = ensureKey();
      const ingestUrl = 'rtmp://example-rtmp-server/live'; // placeholder - orientações para trocar
      const hlsPreview = window.location.hostname ? `${location.protocol}//${location.hostname}:8080/hls/${key}.m3u8` : '';

      area.innerHTML = `
        <div class="row">
          <div class="col-md-8">
            <h4>Configurar transmissão</h4>
            <p class="text-muted">Use as informações abaixo no seu encoder (OBS, vMix, etc.). Este projeto é uma simulação: altere o campo Ingest para seu servidor RTMP/HLS em produção.</p>
            <div class="mb-3">
              <label class="form-label">Servidor de ingest (RTMP)</label>
              <div class="input-group">
                <input id="ingestUrl" class="form-control" value="${ingestUrl}" />
                <button id="copyIngest" class="btn btn-outline-secondary">Copiar</button>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Stream key</label>
              <div class="input-group">
                <input id="streamKey" class="form-control" value="${key}" />
                <button id="copyKey" class="btn btn-outline-secondary">Copiar</button>
                <button id="regenKey" class="btn btn-outline-danger">Regenerar</button>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Exemplo de URL de ingest</label>
              <pre class="small bg-light p-2">${ingestUrl}/{stream_key}</pre>
            </div>
            <div class="alert alert-info">
              <strong>Dica:</strong> Tipos de configuração para OBS: formato=flv, codec de vídeo=h264, perfil=high, bitrate=2500-4000kbps (ajuste conforme necessidade), áudio=128kbps.
            </div>
            <div class="mt-3 d-flex gap-2">
              <a id="startPreview" class="btn btn-primary">Iniciar transmissão de teste</a>
              <a href="transmitir.html" class="btn btn-outline-secondary">Gerenciar transmissões</a>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card p-3">
              <h6>Seu canal</h6>
              <div id="channelPreview"></div>
              <hr>
              <h6>Preview HLS (se disponível)</h6>
              <div id="hlsPreviewWrap">${hlsPreview ? `<a href="${hlsPreview}" target="_blank">Abrir preview HLS</a>` : '<div class="small text-muted">Sem servidor HLS configurado</div>'}</div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('copyIngest').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('ingestUrl').value); alert('URL copiada'); });
      document.getElementById('copyKey').addEventListener('click', ()=>{ navigator.clipboard.writeText(document.getElementById('streamKey').value); alert('Chave copiada'); });
      document.getElementById('regenKey').addEventListener('click', ()=>{
        if(!confirm('Regenerar chave invalidará a chave atual. Continuar?')) return;
        const newKey = 'live-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
        localStorage.setItem('youshipStreamKey', newKey);
        document.getElementById('streamKey').value = newKey;
        alert('Nova chave gerada. Use a nova chave no seu encoder.');
      });

      // carregar info do canal (se houver)
      try{
        const userRaw = localStorage.getItem('youshipUser');
        const user = userRaw ? JSON.parse(userRaw) : {};
        const ch = user.channel || { name: (user.name || auth), avatarDataUrl: '' };
        const wrap = document.getElementById('channelPreview');
        wrap.innerHTML = `<div class="d-flex align-items-center gap-2"><img src="${ch.avatarDataUrl||'https://via.placeholder.com/48'}" class="rounded-circle" width="48" height="48" alt=""><div><div class="fw-bold">${ch.name}</div><div class="small text-muted">${ch.description||''}</div></div></div>`;
      }catch(e){}

      document.getElementById('startPreview').addEventListener('click', ()=>{
        // Para demo, criar uma transmissão simulada (similar a transmitir.html)
        const live = { id: 'live-'+Date.now(), title: 'Transmissão - ' + new Date().toLocaleString(), channel: (JSON.parse(localStorage.getItem('youshipUser')||'{}').channel||{}).name || auth, viewsText: '0 assistindo', time: 'Agora', thumb: 'https://via.placeholder.com/480x270/ff7a00/ffffff?text=Live', category: 'ao-vivo', live: true };
        try{
          const raw = localStorage.getItem('liveStreams');
          const arr = raw ? JSON.parse(raw) : [];
          arr.unshift(live);
          localStorage.setItem('liveStreams', JSON.stringify(arr));
          alert('Transmissão de teste iniciada (simulada). Ela aparecerá em Ao Vivo.');
        }catch(e){ console.error(e); alert('Não foi possível iniciar a transmissão de teste.'); }
      });
    }
  </script>
</body>
</html>
